load("@aspect_bazel_lib//lib:tar.bzl", "tar")
load("@aspect_bazel_lib//lib:testing.bzl", "assert_archive_contains")

# Case 1: Can decompress gzip archive
tar(
    name = "tar",
    srcs = ["srcfile"],
    out = "1.tar.zst",
    compress = "zstd",
)

genrule(
    name = "decompress_tar",
    srcs = [":tar"],
    outs = ["1.tar"],
    cmd = "$(ZSTD_BIN) -f --decompress $(execpath :tar) --stdout > $@",
    toolchains = ["@zstd_toolchains//:resolved_toolchain"],
)

assert_archive_contains(
    name = "test_decompressed",
    archive = "1.tar",
    expected = [
        "lib/tests/zstd/srcfile",
    ],
)
